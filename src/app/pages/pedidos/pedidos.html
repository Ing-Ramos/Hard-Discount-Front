<div class="container mt-4">
  <h2 class="text-primary mb-4 text-center">Gesti√≥n de Pedidos</h2>

  <!-- FILTROS DE BUSQUEDA (solo admin o logistica) -->
  <div class="card p-3 mb-3 shadow-sm" *ngIf="!esCliente">
    <div class="row g-2">
      <div class="col-md-4">
        <input [(ngModel)]="filtroUsuario" type="text" class="form-control" placeholder="Buscar por usuario..." />
      </div>
      <div class="col-md-3">
        <input type="date" class="form-control" [(ngModel)]="filtroFecha" />
      </div>
      <div class="col-md-3">
        <select class="form-select" [(ngModel)]="filtroEstado">
          <option value="">Todos los estados</option>
          <option value="creado">Creado</option>
          <option value="procesando">Procesando</option>
          <option value="enviado">Enviado</option>
          <option value="entregado">Entregado</option>
        </select>
      </div>
      <div class="col-md-2 text-end">
        <button class="btn btn-outline-secondary w-100" (click)="filtroUsuario=''; filtroFecha=''; filtroEstado='';">
          Limpiar filtros
        </button>
      </div>
    </div>
  </div>
  <!-- BOTON EXPORTAR A PDF (solo admin ylog√≠stica) -->
  <div class="text-end mb-2" *ngIf="esAdmin || esLogistica">
    <button class="btn btn-outline-secondary btn-sm" (click)="exportarPDF()">
      <i class="bi bi-filetype-pdf"></i> Exportar PDF
    </button>
  </div>
  <!-- BOTON VER CATALOGO (solo clientes) -->
  <div class="text-end mb-2" *ngIf="esCliente">
    <a routerLink="/catalogo" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-grid"></i> Ver Cat√°logo
    </a>
  </div>
  <!-- FORMULARIO CREAR PEDIDO (visible solo para clientes) -->
  <div class="card p-3 mb-4 shadow-sm" *ngIf="esCliente">
    <h5>Crear nuevo pedido</h5>
    <h6>Productos:</h6>
    <!-- FILAS DE PRODUCTOS -->
    <div *ngFor="let p of nuevoPedido.productos; let i = index" class="row mb-2 align-items-center">
      <div class="col-md-3">
        <input
          type="number"
          [(ngModel)]="p.id"
          (change)="buscarProductoPorId(i)"  
          class="form-control"
          placeholder="ID Producto"
          min="1"
        />
      </div>
      <div class="col-md-3">
        <input
          type="number"
          [(ngModel)]="p.cantidad"
          class="form-control"
          placeholder="Cantidad"
          min="1"
        />
      </div>
      <div class="col-md-3">
        <input
          type="number"
          [(ngModel)]="p.precio"
          class="form-control"
          placeholder="Precio Unitario"
          readonly 
        />
      </div>
      <div class="col-md-3 d-flex align-items-center">
        <button class="btn btn-danger btn-sm" (click)="eliminarProducto(i)">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
    <button class="btn btn-secondary btn-sm mb-3" (click)="agregarProducto()">
      <i class="bi bi-plus-circle"></i> Agregar producto
    </button>
    <div class="text-end">
      <button class="btn btn-success" (click)="crearPedido()">
        <i class="bi bi-cart-plus"></i> Crear Pedido
      </button>
    </div>
  </div>
  <!-- SPINNER DE CARGA -->
  <div class="my-3" *ngIf="cargandoPedidos">
    <div class="d-flex justify-content-center">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <span class="ms-2 align-self-center">Cargando pedidos...</span>
    </div>
  </div>
  <!-- TABLA DE PEDIDOS -->
  <table class="table table-striped table-bordered shadow-sm">
    <thead class="table-dark text-center">
      <tr>
        <th>ID</th>
        <th>Usuario</th>
        <th>Estado</th>
        <th>Fecha Pedido</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let pedido of pedidosPaginados" class="text-center">
        <ng-container *ngIf="pedidoEditando?.id === pedido.id; else modoNormal">
          <td>{{ pedido.id }}</td>
          <td>{{ pedido.usuario }}</td>
          <td>
            <select [(ngModel)]="pedidoEditando.estado" class="form-select form-select-sm text-center">
              <option value="creado">Creado</option>
              <option value="procesando">Procesando</option>
              <option value="enviado">Enviado</option>
              <option value="entregado">Entregado</option>
            </select>
          </td>
          <td>{{ pedido.fechaPedido | date: 'dd/MM/yyyy HH:mm' }}</td>
          <td>
            <button class="btn btn-success btn-sm me-1" (click)="guardarCambios()"></button>
            <button class="btn btn-secondary btn-sm" (click)="cancelarEdicion()"></button>
          </td>
        </ng-container>
        <ng-template #modoNormal>
          <td>{{ pedido.id }}</td>
          <td>{{ pedido.usuario }}</td>
          <td>{{ pedido.estado }}</td>
          <td>{{ pedido.fechaPedido | date: 'dd/MM/yyyy HH:mm' }}</td>
          <td>
            <button class="btn btn-outline-primary btn-sm me-1" (click)="verDetalle(pedido)">üîç</button>
            <button *ngIf="esAdmin || esLogistica" class="btn btn-warning btn-sm me-1" (click)="editarPedido(pedido)">‚úèÔ∏è</button>
            <button class="btn btn-danger btn-sm" (click)="eliminarPedido(pedido.id)">üóëÔ∏è</button>
          </td>
        </ng-template>
      </tr>
    </tbody>
  </table>
  <!-- PAGINACION -->
  <div class="d-flex justify-content-between align-items-center mt-3">
    <div>
      <label class="me-2">Por p√°gina:</label>
      <select [(ngModel)]="tamPagina" class="form-select d-inline-block" style="width:auto" (change)="pagina = 1">
        <option [ngValue]="5">5</option>
        <option [ngValue]="10">10</option>
        <option [ngValue]="20">20</option>
      </select>
    </div>
    <div class="btn-group">
      <button class="btn btn-outline-secondary" (click)="pagina = 1" [disabled]="paginaActual === 1">¬´</button>
      <button class="btn btn-outline-secondary" (click)="pagina = paginaActual - 1" [disabled]="paginaActual === 1">‚Äπ</button>
      <span class="btn btn-outline-dark disabled">P√°gina {{ paginaActual }} / {{ totalPaginas }}</span>
      <button class="btn btn-outline-secondary" (click)="pagina = paginaActual + 1" [disabled]="paginaActual === totalPaginas">‚Ä∫</button>
      <button class="btn btn-outline-secondary" (click)="pagina = totalPaginas" [disabled]="paginaActual === totalPaginas">¬ª</button>
    </div>
  </div>
  <!-- MODAL DETALLES -->
  <div *ngIf="modalAbierto" class="modal-backdrop fade show"></div>
  <div *ngIf="modalAbierto" class="modal d-block" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            Detalle del Pedido #{{ pedidoSeleccionado?.id }} ‚Äî {{ pedidoSeleccionado?.usuario }}
          </h5>
          <button type="button" class="btn-close" (click)="cerrarModal()"></button>
        </div>
        <div class="modal-body">
          <table class="table table-sm table-hover">
            <thead class="table-light">
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario (S/)</th>
                <th>Subtotal (S/)</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of itemsDelPedido">
                <td>{{ item.producto }}</td>
                <td class="text-center">{{ item.cantidad }}</td>
                <td class="text-end">{{ item.precioUnitario | number:'1.2-2' }}</td>
                <td class="text-end">{{ item.subtotal | number:'1.2-2' }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="fw-bold">
                <td colspan="3" class="text-end">TOTAL</td>
                <td class="text-end">{{ totalPedido | number:'1.2-2' }}</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</div>